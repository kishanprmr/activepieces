import { createAction, Property } from '@activepieces/pieces-framework';
import { excelAuth } from '../../index';
import { objectToArray } from '../common/common';
import { commonProps } from '../common/props';
import { createMSGraphClient, getLastUsedRow, numberToColumnName } from '../common/helpers';
import { WorkbookRange } from '@microsoft/microsoft-graph-types';

export const appendRowAction = createAction({
	auth: excelAuth,
	name: 'append_row',
	description: 'Append row of values to a worksheet',
	displayName: 'Append Row to Worksheet',
	props: {
		storageSource: commonProps.storageSource,
		siteId: commonProps.siteId,
		documentId: commonProps.documentId,
		workbookId: commonProps.workbookId,
		worksheetId: commonProps.worksheetId,
		isFirstRowHeaders: Property.Checkbox({
			displayName: 'Does the first row contain headers?',
			description: 'If the first row is headers',
			required: true,
			defaultValue: false,
		}),
		values: commonProps.worksheetValues,
	},
	async run({ propsValue, auth }) {
		const { workbookId, worksheetId, storageSource, siteId, documentId } = propsValue;
		const values = propsValue.isFirstRowHeaders
			? objectToArray(propsValue['values'])
			: Object.values(propsValue['values'])[0];

		if (storageSource === 'sharepoint' && (!siteId || !documentId)) {
			throw new Error('please select SharePoint site and document library.');
		}

		const drivePath =
			storageSource === 'onedrive' ? '/me/drive' : `/sites/${siteId}/drives/${documentId}`;

		const lastUsedRow = await getLastUsedRow(
			auth.access_token,
			drivePath,
			workbookId,
			worksheetId
		);

		const lastUsedColumn = numberToColumnName(Object.values(values).length);

		const rangeFrom = `A${lastUsedRow + 1}`;
		const rangeTo = `${lastUsedColumn}${lastUsedRow + 1}`;
		const insertedRowNumber = lastUsedRow + 1;

		const client = createMSGraphClient(auth.access_token);

		const response: WorkbookRange = await client
			.api(
				`${drivePath}/items/${workbookId}/workbook/worksheets/${worksheetId}/range(address='${rangeFrom}:${rangeTo}')`
			)
			.patch({
				values: [values],
			});

		return {
			row: insertedRowNumber,
			...response,
		};
	},
});
